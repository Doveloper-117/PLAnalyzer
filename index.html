<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2024/25 England League Visual Analytics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- í°íŠ¸ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Poppins', sans-serif; }

        /* --- ë©”ì¸ ë°°ê²½ (ì´ë¯¸ì§€ ì ìš©) --- */
        .bg-main-image {
            background-image: url('dashboard_background.png'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        /* ë©”ì¸ ë°°ê²½ ì˜¤ë²„ë ˆì´ */
        .bg-main-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 0;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            position: relative;
            z-index: 1;
        }
        
        /* --- ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ --- */
        .sidebar-bg {
            background-image: url('menu background.png'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        
        .sidebar-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 0;
        }
        
        .sidebar-content {
            position: relative;
            z-index: 1;
        }
        
        /* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ë°•ìŠ¤ */
        .glass-box {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        .glass-box:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .box-header {
            padding: 0.75rem 1rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #ffffff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .box-content {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
            color: #eeeeee;
            position: relative;
        }

        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        
    </style>
</head>
<body class="bg-main-image h-screen w-screen flex overflow-hidden text-white">

    <!-- 1. ì™¼ìª½ ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content flex-1 flex flex-col p-8 h-full min-w-0">
        
        <!-- í—¤ë” -->
        <div class="mb-6 flex-none">
            <p class="text-xl text-gray-300 font-light tracking-wide uppercase">2024/25 England League Stats</p>
            <h1 class="text-6xl font-display font-black tracking-tight text-white">Overview</h1>
        </div>

        <!-- 2x4 ê·¸ë¦¬ë“œ -->
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 grid-rows-2 gap-4 min-h-0 overflow-y-auto pb-4">

            <!-- [1] ë“ì  ìˆœìœ„ -->
            <div class="glass-box">
                <div class="box-header">1. ë“ì  ìˆœìœ„ (Top Scorers)</div>
                <div class="box-content">
                    <canvas id="top-scorers-chart"></canvas>
                </div>
            </div>

            <!-- [2] ë„ì›€ ìˆœìœ„ -->
            <div class="glass-box">
                <div class="box-header">2. ë„ì›€ ìˆœìœ„ (Assists)</div>
                <div class="box-content">
                    <canvas id="top-assists-chart"></canvas>
                </div>
            </div>

            <!-- [3] xG -->
            <div class="glass-box">
                <div class="box-header">3. xG (eXpected Goals)</div>
                <div class="box-content p-0">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-white/10 text-xs uppercase text-gray-300">
                            <tr><th class="px-3 py-2">Player</th><th class="px-3 py-2 text-right">Conv.%</th></tr>
                        </thead>
                        <tbody id="efficiency-table-body" class="divide-y divide-white/10"></tbody>
                    </table>
                </div>
            </div>

            <!-- [4] íŒ€ ê²€ìƒ‰ -->
            <div class="glass-box">
                <div class="box-header">4. íŒ€ ìƒì„¸ ê²€ìƒ‰</div>
                <div class="box-content flex flex-col gap-3">
                    <div class="flex gap-2">
                        <select id="team-select" class="w-full bg-black/30 border border-white/20 px-3 py-1 text-white focus:outline-none focus:border-[#EBFD54] [&>option]:text-black rounded">
                            <option value="Arsenal">ì•„ìŠ¤ë‚ </option>
                            <option value="Liverpool">ë¦¬ë²„í’€</option>
                            <option value="Manchester City">ë§¨ì‹œí‹°</option>
                            <option value="Tottenham Hotspur">í† íŠ¸ë„˜</option>
                            <option value="Chelsea">ì²¼ì‹œ</option>
                            <option value="Manchester United">ë§¨ìœ </option>
                            <option value="Newcastle United">ë‰´ìºìŠ¬</option>
                            <option value="Aston Villa">ì•„ìŠ¤í†¤ ë¹Œë¼</option>
                        </select>
                        <button onclick="searchTeam()" class="bg-[#EBFD54] text-black font-bold px-3 py-1 hover:bg-white transition rounded">Go</button>
                    </div>
                    <div id="team-result" class="flex-1 bg-black/20 p-2 text-sm rounded">
                        <p class="text-gray-400 text-center mt-8">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>

            <!-- [5] ìµœë‹¤ ì„ ë°© -->
            <div class="glass-box">
                <div class="box-header">5. ìµœë‹¤ ì„ ë°© (Saves)</div>
                <div class="box-content p-0">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-white/10 text-xs uppercase text-gray-300">
                            <tr><th class="px-3 py-2">GK Name</th><th class="px-3 py-2 text-right">Saves</th></tr>
                        </thead>
                        <tbody id="saves-table-body" class="divide-y divide-white/10"></tbody>
                    </table>
                </div>
            </div>

            <!-- [6] ì„±ì  ì¶”ì´ -->
            <div class="glass-box">
                <div class="box-header">6. ì‹œì¦Œ ì„±ì  ì¶”ì´ (Trend)</div>
                <div class="box-content">
                    <canvas id="team-trend-chart"></canvas>
                </div>
            </div>

            <!-- [7] ì˜ˆì¸¡ -->
            <div class="glass-box">
                <div class="box-header">7. ë‹¤ìŒ ì‹œì¦Œ ì˜ˆì¸¡</div>
                <div class="box-content flex flex-col justify-center items-center text-center" id="prediction-box">
                    <div class="text-gray-400 text-sm">AI Prediction Model</div>
                    <div class="text-3xl font-black text-[#EBFD54] mt-2">--</div>
                    <div class="text-xs uppercase tracking-widest mt-1 text-white/50">Target Required</div>
                </div>
            </div>

            <!-- [8] ì„ ìˆ˜ ê²€ìƒ‰ -->
            <div class="glass-box">
                <div class="box-header">8. ì„ ìˆ˜ ìƒì„¸ ê²€ìƒ‰</div>
                <div class="box-content flex flex-col gap-3">
                    <div class="flex gap-2">
                        <input type="text" id="player-input" placeholder="ì„ ìˆ˜ëª… (ì˜ˆ: Saka)" 
                               class="w-full bg-black/30 border border-white/20 px-3 py-1 text-white focus:outline-none focus:border-[#EBFD54] rounded">
                        <button onclick="searchPlayer()" class="bg-[#EBFD54] text-black font-bold px-3 py-1 hover:bg-white transition rounded">ğŸ”</button>
                    </div>
                    <div id="player-result" class="flex-1 bg-black/20 p-2 text-sm overflow-auto rounded">
                        <p class="text-gray-400 text-center mt-8">ì„ ìˆ˜ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- 2. ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
    <aside class="w-24 md:w-64 sidebar-bg flex flex-col items-center py-8 shadow-2xl relative z-10 text-white">
        
        <div class="sidebar-content flex flex-col items-center w-full h-full">
            
            <!-- ë¡œê³  ì´ë¯¸ì§€ -->
            <div class="mb-16">
                <!-- ì´ë¯¸ì§€ íŒŒì¼ëª…: logo.png -->
                <img src="logo.png" alt="EA Logo" class="w-24 h-24 object-contain drop-shadow-lg">
            </div>

            <!-- ë©”ë‰´ëŠ” ìš”ì²­ëŒ€ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤ -->
            
        </div>
    </aside>

    <!-- 3. ìë°”ìŠ¤í¬ë¦½íŠ¸ (ì•ˆì „ëª¨ë“œ ì ìš©ë¨) -->
    <script>
        const API_URL = 'http://127.0.0.1:5000/api';
        Chart.defaults.color = '#ccc';
        Chart.defaults.font.family = 'Inter';
        Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.05)';

        let scorersChart, assistsChart, trendChart = null;

        window.addEventListener('load', () => {
            loadTopScorers();
            loadEfficiency();
            loadTopAssisters();
            loadTopSavers();
        });

        // [í•µì‹¬] ì•ˆì „í•œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ì„œë²„ êº¼ì§€ë©´ ì„ì‹œ ë°ì´í„° ì‚¬ìš©)
        async function fetchData(endpoint) {
            try {
                // 1. ì„œë²„ì— ìš”ì²­ ì‹œë„
                const response = await fetch(`${API_URL}${endpoint}`);
                if (!response.ok) throw new Error('API Error');
                return await response.json();
            } catch (error) {
                // 2. ì‹¤íŒ¨í•˜ë©´ ì„ì‹œ ë°ì´í„°(Mock Data) ë°˜í™˜
                console.warn(`ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (${endpoint}). ì„ì‹œ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.`, error);
                return getMockData(endpoint);
            }
        }

        // ì„ì‹œ ë°ì´í„° ìƒì„±ê¸° (ì„œë²„ê°€ êº¼ì ¸ìˆì„ ë•Œ í™”ë©´ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•¨)
        function getMockData(endpoint) {
            if (endpoint.includes('top-scorers')) return [
                { 'Player Name': 'Haaland', 'Goals': 27 }, { 'Player Name': 'Palmer', 'Goals': 22 },
                { 'Player Name': 'Isak', 'Goals': 21 }, { 'Player Name': 'Watkins', 'Goals': 19 },
                { 'Player Name': 'Solanke', 'Goals': 19 }
            ];
            if (endpoint.includes('top-assisters')) return [
                { 'Player Name': 'Watkins', 'Assists': 13 }, { 'Player Name': 'Palmer', 'Assists': 11 },
                { 'Player Name': 'De Bruyne', 'Assists': 10 }, { 'Player Name': 'Salah', 'Assists': 10 },
                { 'Player Name': 'Gordon', 'Assists': 10 }
            ];
            if (endpoint.includes('efficient-finishers')) return [
                { 'Player Name': 'Mateta', 'Conversion_Rate': 29.5 }, { 'Player Name': 'Wood', 'Conversion_Rate': 28.1 },
                { 'Player Name': 'Haaland', 'Conversion_Rate': 26.4 },
                { 'Player Name': 'Palmer', 'Conversion_Rate': 25.8 }, { 'Player Name': 'Isak', 'Conversion_Rate': 24.3 }
            ];
            if (endpoint.includes('top-savers')) return [
                { 'Player Name': 'Onana', 'Saves': 149 }, { 'Player Name': 'Kaminski', 'Saves': 145 },
                { 'Player Name': 'Areola', 'Saves': 138 }, { 'Player Name': 'Pickford', 'Saves': 121 },
                { 'Player Name': 'Leno', 'Saves': 120 }
            ];
            if (endpoint.includes('/predict/')) { // ì˜ˆì¸¡ ëª¨ì˜ ë°ì´í„°
                return { 'predicted_goals': 18, 'predicted_assists': 12, 'predicted_rank': 2, 'predicted_points': 86 };
            }
            if (endpoint.includes('/stats/player/')) { // ì„ ìˆ˜ ëª¨ì˜ ë°ì´í„°
                const name = endpoint.split('/').pop();
                return {
                    'Club': 'Mock FC', 'Goals': 15, 'Assists': 10, 'Shots': 50, 
                    'Goal_Contribution_Pct': 35.5, 'Player Name': decodeURIComponent(name), 'Goals_per90': 0.65
                };
            }
            if (endpoint.includes('/stats/team/')) { // íŒ€ ëª¨ì˜ ë°ì´í„°
                return {
                    'stats': { 'points': 89, 'goals_for': 91, 'goals_against': 29 },
                    'trend': { 
                        'labels': ['8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”', '1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”'], 
                        'points_per_month': [9, 7, 9, 6, 12, 9, 7, 10, 12, 8] 
                    }
                };
            }
            return {};
        }

        async function loadTopScorers() {
            const data = await fetchData('/stats/top-scorers');
            const ctx = document.getElementById('top-scorers-chart').getContext('2d');
            if (scorersChart) scorersChart.destroy();
            scorersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d['Player Name']),
                    datasets: [{ label: 'ë“ì (Goals)', data: data.map(d => d['Goals']), backgroundColor: '#EBFD54', borderRadius: 4, barThickness: 15 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        async function loadTopAssisters() {
            const data = await fetchData('/stats/top-assisters');
            const ctx = document.getElementById('top-assists-chart').getContext('2d');
            if (assistsChart) assistsChart.destroy();
            assistsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d['Player Name']),
                    datasets: [{ label: 'ë„ì›€(Assists)', data: data.map(d => d['Assists']), backgroundColor: '#76FA95', borderRadius: 4, barThickness: 15 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        async function loadEfficiency() {
            const data = await fetchData('/stats/efficient-finishers');
            document.getElementById('efficiency-table-body').innerHTML = data.slice(0, 5).map(p => `
                <tr class="hover:bg-white/10 transition"><td class="px-3 py-2 text-xs truncate max-w-[80px]">${p['Player Name']}</td><td class="px-3 py-2 text-right text-xs font-bold text-[#EBFD54]">${p['Conversion_Rate'].toFixed(1)}%</td></tr>
            `).join('');
        }

        async function loadTopSavers() {
            const data = await fetchData('/stats/top-savers');
            document.getElementById('saves-table-body').innerHTML = data.slice(0, 5).map(p => `
                <tr class="hover:bg-white/10 transition"><td class="px-3 py-2 text-xs truncate max-w-[80px]">${p['Player Name']}</td><td class="px-3 py-2 text-right text-xs font-bold text-[#76FA95]">${p['Saves']}</td></tr>
            `).join('');
        }

        async function searchPlayer() {
            const name = document.getElementById('player-input').value;
            const resBox = document.getElementById('player-result');
            const predBox = document.getElementById('prediction-box');
            if(!name) return;
            
            const data = await fetchData(`/stats/player/${encodeURIComponent(name)}`);
            if (data.error) { resBox.innerHTML = `<p class="text-red-400 text-center">${data.error}</p>`; return; }

            resBox.innerHTML = `
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between"><span class="text-gray-400">Club</span><span class="font-bold">${data.Club}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Goals</span><span class="text-[#EBFD54] font-bold">${data.Goals}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Assists</span><span class="text-[#EBFD54] font-bold">${data.Assists}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Shots</span> <span>${data.Shots}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">G/90</span><span>${data.Goals_per90 ? data.Goals_per90.toFixed(2) : '-'}</span></div>
                </div>`;

            const predData = await fetchData(`/predict/player/${encodeURIComponent(name)}`);
            predBox.innerHTML = `
                <div class="text-xs text-gray-300 mb-1">${data['Player Name']}</div>
                <div class="flex gap-2 justify-center text-center">
                    <div><div class="text-[9px] text-gray-400">Exp.G</div><div class="text-lg font-bold text-[#EBFD54]">${predData.predicted_goals}</div></div>
                    <div><div class="text-[9px] text-gray-400">Exp.A</div><div class="text-lg font-bold text-[#EBFD54]">${predData.predicted_assists}</div></div>
                </div>`;
        }

        async function searchTeam() {
            const team = document.getElementById('team-select').value;
            const resBox = document.getElementById('team-result');
            const predBox = document.getElementById('prediction-box');
            
            const data = await fetchData(`/stats/team/${team}`);
            const stats = data.stats;
            const trend = data.trend;

            resBox.innerHTML = `
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between"><span class="text-gray-400">Pts</span><span class="font-bold text-lg">${stats.points}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">GF</span><span class="text-[#EBFD54]">${stats.goals_for}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">GA</span><span class="text-red-400">${stats.goals_against}</span></div>
                </div>`;

            if (trendChart) trendChart.destroy();
            const ctx = document.getElementById('team-trend-chart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: trend.labels, datasets: [{ label: 'Pts', data: trend.points_per_month, borderColor: '#EBFD54', backgroundColor: 'rgba(235, 253, 84, 0.1)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });

            const predData = await fetchData(`/predict/team/${team}`);
            predBox.innerHTML = `
                <div class="text-xs text-gray-300 mb-1">${team}</div>
                <div class="text-center"><div class="text-3xl font-black text-[#EBFD54]">${predData.predicted_rank}<span class="text-sm text-white">ìœ„</span></div><div class="text-[9px] text-gray-400">Exp. Pts: ${predData.predicted_points}</div></div>`;
        }
    </script>
</body>
</html>